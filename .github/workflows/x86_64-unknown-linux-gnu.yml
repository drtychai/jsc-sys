name: gnu

on:
  push:
    branches:
        - master
        - dev
  pull_request:
    branches:
        - master
        - dev

env:
  CARGO_TERM_COLOR: always

jobs:
  build-gnu:
    runs-on: ubuntu-20.04

    steps:
    - name: pull-all-source
      uses: actions/checkout@v2
      with:
        repository: '${{ github.repository }}'
        submodules: 'true'

    - name: install deps
      run: |
        sudo apt update --fix-missing
        sudo apt install -y -f libapache2-mod-php
        sudo apt install -y \
          autoconf automake autopoint autotools-dev \
          bubblewrap cmake gawk geoclue-2.0 gnome-common gperf gtk-doc-tools \
          intltool itstool libasound2-dev libatk1.0-dev libedit-dev libenchant-dev \
          libevent-dev libfaad-dev libffi-dev libfile-copy-recursive-perl libgcrypt20-dev \
          libgirepository1.0-dev libgl1-mesa-dev libgl1-mesa-glx libgtk-3-dev \
          libgstreamer1.0-dev libgstreamer-plugins-bad1.0-dev libgstreamer-plugins-base1.0-dev \
          libgudev-1.0-dev libhyphen-dev libjpeg-dev libmount-dev libmpg123-dev libnotify-dev \
          libopenjp2-7-dev libopus-dev libpango1.0-dev libpng-dev libpulse-dev librsvg2-dev \
          libseccomp-dev libsecret-1-dev libsoup2.4-dev libsqlite3-dev libsrtp2-dev \
          libsystemd-dev libtasn1-6-dev libtheora-dev libtool libvorbis-dev libvpx-dev \
          libupower-glib-dev libwebp-dev libwoff-dev libxcomposite-dev libxt-dev \
          libxtst-dev libxslt1-dev libwayland-dev ninja-build patch ruby xfonts-utils \
          apache2 curl cups-daemon dbus-x11 gdb fonts-liberation hunspell hunspell-en-us \
          hunspell-en-gb libapache2-mod-bw libapache2-mod-php php-json libcgi-pm-perl \
          libgpg-error-dev psmisc pulseaudio-utils python-gi python-psutil python-yaml \
          ruby ruby-json ruby-highline weston xvfb bison flex git gobject-introspection \
          gsettings-desktop-schemas-dev gyp icon-naming-utils libcroco3-dev libcups2-dev \
          libdrm-dev libegl1-mesa-dev libepoxy-dev libevdev-dev libexpat1-dev libfdk-aac-dev \
          libgbm-dev libgles2-mesa-dev libgnutls28-dev libgpg-error-dev libjson-glib-dev \
          libinput-dev libmtdev-dev liborc-0.4-dev libp11-kit-dev libpciaccess-dev \
          libproxy-dev libpsl-dev libssl-dev libtiff5-dev libunistring-dev libv4l-dev \
          libxcb-composite0-dev libxcb-xfixes0-dev libxfont-dev libxfont2 libxkbfile-dev \
          libxkbcommon-x11-dev libtool-bin libudev-dev libxml-libxml-perl python-dev \
          python3-setuptools ragel uuid-dev x11proto-bigreqs-dev x11proto-composite-dev \
          x11proto-gl-dev x11proto-input-dev x11proto-randr-dev x11proto-resource-dev \
          x11proto-scrnsaver-dev x11proto-video-dev x11proto-xcmisc-dev x11proto-xf86dri-dev \
          xfonts-utils xtrans-dev xutils-dev yasm git-svn python3-secretstorage subversion \
          gstreamer1.0-gl gstreamer1.0-libav gstreamer1.0-plugins-bad gstreamer1.0-plugins-base \
          gstreamer1.0-plugins-good gstreamer1.0-plugins-ugly gstreamer1.0-pulseaudio
        sudo apt clean

    - name: build
      run: cargo build -vv --target=x86_64-unknown-linux-gnu

  build-gnu-2:
    runs-on: ubuntu-20.04

    steps:
    - name: pull-all-source
      uses: actions/checkout@v2
      with:
        repository: '${{ github.repository }}'
        submodules: 'true'

    - name: install deps
      run: |
        sudo apt update --fix-missing && sudo apt install -y -f libapache2-mod-php
        sudo $( find ~ -path '*/Tools/gtk/install-dependencies' )
        sudo $( find ~ -path '*/Tools/Scripts/update-webkitgtk-libs' ) 

    - name: build
      run: cargo build -vv --target=x86_64-unknown-linux-gnu

